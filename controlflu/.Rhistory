ts$dosesPriv[which(ts$year == i)] <-
sum(ir$doses[which(ir$year == i &
ir$pubPriv == "priv")],
na.rm=TRUE)
}
###################
# PRIVATE TOTAL STUDENTS PER YEAR
###################
ts$totMemPriv <- NA
for (i in ts$year){
ts$totMemPriv[which(ts$year == i)] <-
sum(ir$totMem[which(ir$year == i &
ir$pubPriv == "priv")],
na.rm=TRUE)
}
###################
# IMMRATE PRIVATE
###################
ts$immRatePriv <- ts$dosesPriv/ts$totMemPriv
###################
# ADD UPPER AND LOWERBOUND TO TS FOR PRIV/PUB IMMRATES
###################
#PRIV LOWER
ts$immRatePrivLower <- NA
for (i in ts$year){
temp <- simpasym(n=sum(ir$doses[which(ir$year == i &
ir$pubPriv == "priv")]),
p=sum(ir$doses[which(ir$year == i &
ir$pubPriv == "priv")])/
sum(ir$totMem[which(ir$year == i &
ir$pubPriv == "priv")]),
z=1.96,
cc=TRUE)
ts$immRatePrivLower[which(ts$year == i)] <- temp$lb
}
#PRIV UPPER
ts$immRatePrivUpper <- NA
for (i in ts$year){
temp <- simpasym(n=sum(ir$doses[which(ir$year == i &
ir$pubPriv == "priv")]),
p=sum(ir$doses[which(ir$year == i &
ir$pubPriv == "priv")])/
sum(ir$totMem[which(ir$year == i &
ir$pubPriv == "priv")]),
z=1.96,
cc=TRUE)
ts$immRatePrivUpper[which(ts$year == i)] <- temp$ub
}
ts$immRatePrivCI <- paste0(round(100*ts$immRatePrivLower, digits=2), "-", round(100*ts$immRatePrivUpper, digits=2))
#########################################################
###################
# PUBLIC DOSES
###################
ts$dosesPub <- NA
for (i in ts$year){
ts$dosesPub[which(ts$year == i)] <-
sum(ir$doses[which(ir$year == i &
ir$pubPriv == "pub")],
na.rm=TRUE)
}
###################
# PUBLIC TOTAL STUDENTS PER YEAR
###################
ts$totMemPub <- NA
for (i in ts$year){
ts$totMemPub[which(ts$year == i)] <-
sum(ir$totMem[which(ir$year == i &
ir$pubPriv == "pub")],
na.rm=TRUE)
}
###################
# IMMRATE PUBLIC
###################
ts$immRatePub <- ts$dosesPub/ts$totMemPub
#PUB LOWER
ts$immRatePubLower <- NA
for (i in ts$year){
temp <- simpasym(n=sum(ir$doses[which(ir$year == i &
ir$pubPriv == "pub")]),
p=sum(ir$doses[which(ir$year == i &
ir$pubPriv == "pub")])/
sum(ir$totMem[which(ir$year == i &
ir$pubPriv == "pub")]),
z=1.96,
cc=TRUE)
ts$immRatePubLower[which(ts$year == i)] <- temp$lb
}
#PUB Upper
ts$immRatePubUpper <- NA
for (i in ts$year){
temp <- simpasym(n=sum(ir$doses[which(ir$year == i &
ir$pubPriv == "pub")]),
p=sum(ir$doses[which(ir$year == i &
ir$pubPriv == "pub")])/
sum(ir$totMem[which(ir$year == i &
ir$pubPriv == "pub")]),
z=1.96,
cc=TRUE)
ts$immRatePubUpper[which(ts$year == i)] <- temp$ub
}
ts$immRatePubCI <- paste0(round(100*ts$immRatePubLower, digits=2), "-", round(100*ts$immRatePubUpper, digits=2))
#########################################################
###################
# ADD A COLUMN FOR EACH SCHOOL
###################
for (i in unique(sort(ir$id))){
ts[,paste0("school",i)] <- NA
}
for (i in ts$year){
for (j in unique(sort(ir$id))){
ts[which(ts$year == i), paste0("school",j)] <-
ir$immRate[which(ir$year == i &
ir$id == j)][1]
}
}
###################
# CREATE PUB PRIV DATA FRAMES SIMPLE TS FOR WRITE-UP
###################
#PRIV
tsPriv <- ts[,c("year",
"dosesPriv",
"totMemPriv",
"immRatePriv",
"immRatePrivCI")]
tsPriv$immRatePriv <- round(tsPriv$immRatePriv*100, digits=2)
tsPriv$dosesPriv <- as.character(tsPriv$dosesPriv)
tsPriv$year <- as.character(tsPriv$year)
tsPriv <- tsPriv[which(tsPriv$year >=2010),]
tsPriv2 <- tsPriv
colnames(tsPriv2) <- c("Year",
"Doses",
"Students",
"I.R.",
"95% C.I.")
#Pub
tsPub <- ts[,c("year",
"dosesPub",
"totMemPub",
"immRatePub",
"immRatePubCI")]
tsPub$immRatePub <- round(tsPub$immRatePub*100, digits=2)
tsPub$dosesPub <- as.character(tsPub$dosesPub)
tsPub$year <- as.character(tsPub$year)
tsPub2 <- tsPub
colnames(tsPub2) <- c("Year",
"Doses",
"Students",
"I.R.",
"95% C.I.")
###################
# PLOT ALL SCHOOLS
###################
#LAYOUT
plot(x=ts$year,
y=ts$immRatePriv,
type="n",
col="red",
ylim=c(0,0.8),
xlim=c(2006, 2013),
xaxt="n",
xlab="Year",
yaxt="n",
ylab="Immunization rate")
#AXIS
axis(side=1, at=ts$year,
labels=paste0(ts$year,"-\n",ts$year+1, " "),
cex.axis=1,
tick=FALSE,
line=1)
axis(side=2, at=seq(0,1,0.2),
labels=paste0(seq(0,1,0.2)*100,
"%"), las=1)
#GRIDLINES
abline(h=seq(0,1,0.1),
col=adjustcolor("black", alpha.f=0.2))
abline(v=2006:2013,
col=adjustcolor("black", alpha.f=0.2))
###################
# ADD PUBLIC SCHOOLS
###################
for (i in link$id[which(link$pubPriv == "pub")]){
lines(ts$year,
ts[,paste0("school",i)],
col=adjustcolor("darkblue", alpha.f=0.1),
lwd=.2*ir$totMem[which(ir$id == i)]^(1/2)[1])
}
###################
# ADD MEAN PUBLIC
###################
lines(x=ts$year,
y=ts$immRatePub,
col=adjustcolor("darkblue", alpha.f=0.6),
lwd=1)
points(x=ts$year,
y=ts$immRatePub,
pch=16,
col=adjustcolor("darkblue", alpha.f=0.6),
cex=1)
###################
# ADD PRIVATE SCHOOLS
###################
for (i in link$id[which(link$pubPriv == "priv")]){
lines(ts$year,
ts[,paste0("school",i)],
col=adjustcolor("darkred", alpha.f=0.1),
lwd=.2*ir$totMem[which(ir$id == i)]^(1/2)[1])
}
###################
# ADD MEAN PRIVATE
###################
lines(x=ts$year,
y=ts$immRatePriv,
col=adjustcolor("darkred", alpha.f=0.6),
lwd=1)
points(x=ts$year,
y=ts$immRatePriv,
pch=17,
col=adjustcolor("darkred", alpha.f=0.6),
cex=1.5)
###################
# PLOT ALL SCHOOLS
###################
par(mar=c(4,3,2,1))
par(oma=c(0,0,0,0))
par(mfrow=c(6,4))
#PUBLIC
for (i in link$id[which(link$pubPriv == "pub")]){
plot(x=ts$year,
y=ts[,paste0("school", i)],
col=adjustcolor("darkblue", alpha.f=0.6),
type="l",
ylim=c(0,1),
xlim=c(2006, 2013),
xaxt="n",
xlab=NA,
yaxt="n",
ylab="Immunization rate",
lwd=2,
main=link$school[which(link$id == i)],
cex.main=1)
#XLAB
#mtext("Year", side=1, line=1,
#     cex=0.6)
# POINTS
points(x=ts$year,
y=ts[,paste0("school", i)],
col=adjustcolor("darkblue", alpha.f=0.6),
pch=16)
#AXIS
axis(side=1, at=ts$year,
labels=gsub("20", "",paste0(ts$year,"-\n",ts$year+1, " ")),
cex.axis=0.8,
tick=FALSE,
line=0)
axis(side=2, at=seq(0,1,0.2),
labels=paste0(seq(0,1,0.2)*100,
"%"), las=1,
cex.axis=0.8)
#GRIDLINES
abline(h=seq(0,1,0.1),
col=adjustcolor("black", alpha.f=0.2))
abline(v=2006:2013,
col=adjustcolor("black", alpha.f=0.2))
text(x=ts$year,
y=ts[,paste0("school", i)]+0.08,
labels=paste0(round(100*ts[,paste0("school", i)], digits=1),
"%"),
col=adjustcolor("black", alpha.f=0.6),
cex=0.5)
}
par(mar=c(4,3,2,1))
par(oma=c(0,0,0,0))
par(mfrow=c(6,4))
#PRIVATE
for (i in link$id[which(link$pubPriv == "priv")]){
plot(x=ts$year,
y=ts[,paste0("school", i)],
col=adjustcolor("darkred", alpha.f=0.6),
type="l",
ylim=c(0,1),
xlim=c(2006, 2013),
xaxt="n",
xlab=NA,
yaxt="n",
ylab="Immunization rate",
lwd=2,
main=link$school[which(link$id == i)],
cex.main=1)
#XLAB
#mtext("Year", side=1, line=1,
#     cex=0.6)
# POINTS
points(x=ts$year,
y=ts[,paste0("school", i)],
col=adjustcolor("darkred", alpha.f=0.6),
pch=16)
#AXIS
axis(side=1, at=ts$year,
labels=gsub("20", "",paste0(ts$year,"-\n",ts$year+1, " ")),
cex.axis=0.8,
tick=FALSE,
line=0)
axis(side=2, at=seq(0,1,0.2),
labels=paste0(seq(0,1,0.2)*100,
"%"), las=1,
cex.axis=0.8)
#GRIDLINES
abline(h=seq(0,1,0.1),
col=adjustcolor("black", alpha.f=0.2))
abline(v=2006:2013,
col=adjustcolor("black", alpha.f=0.2))
text(x=ts$year,
y=ts[,paste0("school", i)]+0.08,
labels=paste0(round(100*ts[,paste0("school", i)], digits=1),
"%"),
col=adjustcolor("black", alpha.f=0.6),
cex=0.5)
}
###################
#
###################
###################
#
###################
###################
#
###################
###################
#
###################
###################
#
###################
###################
# PLOT
###################
par(mfrow=c(1,1))
#PRIVATE
plot(x=ts$year,
y=ts$immRatePriv,
type="l",
col="red",
ylim=c(.3,.6),
xlim=c(2010, 2013),
xaxt="n",
xlab="Year",
yaxt="n",
ylab="Immunization rate")
points(x=ts$year,
y=ts$immRatePriv,
pch=17,
col="red")
#PUBLIC
lines(x=ts$year,
y=ts$immRatePub,
col="blue")
points(x=ts$year,
y=ts$immRatePub,
pch=16,
col="blue")
#AXIS
axis(side=1, at=ts$year,
labels=paste0(ts$year,"-\n",ts$year+1),
cex.axis=1,
tick=FALSE)
axis(side=2, at=seq(0,1,0.1),
labels=paste0(seq(0,1,0.1)*100,
"%"))
#LEGEND
legend(x="topleft",
col=c("blue", "red"),
pch=c(16,17),
lty=1,
legend=c("Public", "Private"),
bty="n")
#GRIDLINES
abline(h=seq(0,1,0.05),
col=adjustcolor("black", alpha.f=0.2))
abline(v=c(2010,2011,2012,2013),
col=adjustcolor("black", alpha.f=0.2))
#TITLE
title(main="Weighted mean immunization rate",
outer=TRUE, line=-1)
#### BARPLOT OF IMM AND CONFINT
library(Hmisc)
#PUBLIC
par(mfrow=c(1,1))
mybp <- barplot(ts$immRatePub*100,
ylim=c(0,50),
col=adjustcolor("darkblue", alpha.f=0.4),
border=NA)
abline(h=seq(0,100,10),
col=adjustcolor("black", alpha.f=0.2))
errbar(x=mybp[,1]-0.1,
y=ts$immRatePub*100,
yplus=ts$immRatePubUpper*100,
yminus = ts$immRatePubLower*100,
add=TRUE,
type="n",
errbar.col=adjustcolor("darkblue", alpha.f=0.6))
#PRIVATE
mybp <- barplot(ts$immRatePriv*100,
ylim=c(0,50),
col=adjustcolor("darkred", alpha.f=0.4),
border=NA,
add=TRUE)
errbar(x=mybp[,1]+0.1,
y=ts$immRatePriv*100,
yplus=ts$immRatePrivUpper*100,
yminus = ts$immRatePrivLower*100,
add=TRUE,
type="n",
errbar.col=adjustcolor("darkred", alpha.f=0.6))
#AXIS
axis(side=1, at=mybp[,1],labels=ts$year,
tick=FALSE)
#LEGEND
legend(x="topleft",
fill=adjustcolor(c("darkblue", "darkred"),alpha.f=0.6),
legend=c("Public", "Private"),
bty="n",
border=FALSE)
#T.TEST
library(weights)
wtd.t.test(x=ir$immRate[which(ir$pubPriv == "pub" &
ir$year >=2010)],
y=ir$immRate[which(ir$pubPriv == "priv")],
weight=ir$totMem[which(ir$pubPriv == "pub" &
ir$year >=2010)],
weighty=ir$totMem[which(ir$pubPriv == "priv")],
samedata=FALSE)
###################
# COMPARE JUST ELEMENTARY SCHOOLS (per Parker's request on 20 May 2014)
###################
#T.TEST
wtd.t.test(x=ir$immRate[which(ir$pubPriv == "pub" &
ir$year >=2010 &
ir$type == "elem")],
y=ir$immRate[which(ir$pubPriv == "priv" &
ir$type == "elem")],
weight=ir$totMem[which(ir$pubPriv == "pub" &
ir$year >=2010 &
ir$type == "elem")],
weighty=ir$totMem[which(ir$pubPriv == "priv" &
ir$type == "elem")],
samedata=FALSE)
#SAVE IMAGE
save.image("E:/fdoh/private/fluMist/immRatesHistorical/pubVsPriv/immRates.RData")
######################
# FOR PAUL, DOES REVIEW AND PURSUE MAKE A DIFFERENCE?
######################
###############
# MERGE FR/RE LUNCH INFO WITH IR
###############
library(plyr)
x <- join(x = ir,
y = frLunch,
by = "id",
type = "left")
ir <- x
rm(x)
head(ir)
ir$school <- NULL
head(link)
link.small <- link[,c("id", "school")]
ir <- join(x = ir,
y = link.small,
by = "id",
type = "left")
head(ir)
ir$school <- toupper(ir$school)
head(ir)
ir$frLunch13 <- NULL
head(ir)
nrow(ir[which(ir$year == 2009),])
write.csv(ir, "e:/fdoh/private/fluMist/ir.csv")
#######################
# ATTACH LIBRARIES
#######################
library(RCurl)
library(RColorBrewer)
suppressPackageStartupMessages(library(googleVis))
#######################
# READ IN IMMUNIZATION HISTORY FROM GOOGLE
#######################
options(RCurlOptions = list(cainfo = system.file("CurlSSL", "cacert.pem", package = "RCurl")))
myLink <- "https://docs.google.com/spreadsheets/d/1W3j0WVtGfT3-oQr3vqt45hRMbmbDzJL2spToWD2XtE8/export?&format=csv"
myCsv <- getURL(myLink)
ir <- read.csv(textConnection(myCsv), skip=0)
rm(myCsv, myLink)
#######################
# PLOT
#######################
M <- gvisMotionChart(ir, idvar="school", timevar="year")
plot(M)
M <- gvisMotionChart(data = ir, idvar="school", timevar="year")
plot(M)
M <- gvisMotionChart(data = ir,
idvar = "school",
timevar = "year",
xvar = "p.vfc",
ylab = "immRate",
colorvar = "pubPriv",
sizevar = "totMem")
M <- gvisMotionChart(data = ir,
idvar = "school",
timevar = "year",
xvar = "p.vfc",
yvar = "immRate",
colorvar = "pubPriv",
sizevar = "totMem")
plot(M)
